---
id: et-f597
status: open
deps: [et-03b4]
links: []
created: 2026-02-03T16:42:15Z
type: task
priority: 1
assignee: Bruce Mitchener
tags: [vm, trace, perf, spans]
---
# Speed up span lookup (avoid per-instr span table scan)

`ExecutionContext::span_at()` currently scans the function span table linearly on every instruction, which is avoidable work in the hot loop.

Add a faster span lookup strategy, e.g.:
- Precompute a `Vec<Option<u64>>` of `span_id` per decoded instruction at verify time (preferred if memory is acceptable), or
- Maintain a per-frame cursor into the span table so lookup becomes amortized O(1) as `pc` increases, or
- Build a searchable table of cumulative pcs and binary-search.

Use the faster path for:
- trap reporting
- trace events (ScopeEnter/Instr)

Acceptance:
- Same semantics as today for all existing tests.
- Benchmarks should not regress; ideally improve instruction-heavy runs.
- No new dependencies.

