---
id: et-03b4
status: open
deps: []
links: []
created: 2026-02-03T16:42:07Z
type: task
priority: 1
assignee: Bruce Mitchener
tags: [vm, trace, ergonomics]
---
# TraceCtx helper for VM tracing

Today `Vm::run` has repeated `trace_mask.contains(...)` + `Option<&mut dyn TraceSink>` unwrapping at several sites (INSTR/CALL/HOST).

However, storing `Option<&mut dyn TraceSink>` inside `ExecutionContext` fights Rust borrow rules (self-borrow/lifetime issues).

Add a small stack-only helper like `TraceCtx<'a> { mask: TraceMask, sink: Option<&'a mut dyn TraceSink> }` with methods:
- `trace_instr(program: &Program, ...)`
- `trace_scope_enter(program: &Program, ...)`
- `trace_scope_exit(program: &Program, ...)`

Then refactor `Vm::run` to use `TraceCtx` so the hot loop stops repeating unwrapping/indentation, without changing ownership topology.

Acceptance:
- No behavior change (events emitted under the same conditions).
- No allocations added.
- `cargo clippy -- -D warnings` passes.

